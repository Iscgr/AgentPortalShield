/**
 * SHERLOCK v34.1: COMPREHENSIVE PAYMENT ALLOCATION MANAGEMENT
 * ATOMOS COMPLIANT - Complete payment allocation interface with manual and auto features
 */

import React, { useState, useEffect } from 'react';
import axios from '../lib/axios';
import { Button } from '../components/ui/button';
import { Input } from '../components/ui/input';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';
import { Badge } from '../components/ui/badge';
import { Alert, AlertDescription } from '../components/ui/alert';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '../components/ui/tabs';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../components/ui/select';
import { Textarea } from '../components/ui/textarea';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from '../components/ui/dialog';
import { Label } from '../components/ui/label';
import { Separator } from '../components/ui/separator';
import { CheckCircle, XCircle, Clock, AlertTriangle, Zap, Target, DollarSign } from 'lucide-react';

interface Payment {
  id: number;
  representativeId: number;
  invoiceId?: number;
  amount: string;
  paymentDate: string;
  description?: string;
  isAllocated: boolean;
  createdAt: string;
}

interface Invoice {
  id: number;
  invoiceNumber: string;
  representativeId: number;
  amount: string;
  issueDate: string;
  dueDate?: string;
  status: string;
  createdAt: string;
}

interface Representative {
  id: number;
  name: string;
  code: string;
  totalDebt: string;
}

interface AllocationResult {
  success: boolean;
  allocatedAmount: number;
  remainingAmount: number;
  allocations: any[];
  errors: string[];
  warnings: string[];
  transactionId: string;
  processingTime: number;
}

const PaymentManagement: React.FC = () => {
  const [payments, setPayments] = useState<Payment[]>([]);
  const [unallocatedPayments, setUnallocatedPayments] = useState<Payment[]>([]);
  const [representatives, setRepresentatives] = useState<Representative[]>([]);
  const [invoices, setInvoices] = useState<Invoice[]>([]);
  const [loading, setLoading] = useState(false);
  const [selectedRepresentative, setSelectedRepresentative] = useState<number | null>(null);
  const [autoAllocationResults, setAutoAllocationResults] = useState<any>(null);
  const [manualAllocationDialog, setManualAllocationDialog] = useState(false);
  const [selectedPayment, setSelectedPayment] = useState<Payment | null>(null);

  // Manual allocation form states
  const [manualForm, setManualForm] = useState({
    paymentId: '',
    invoiceId: '',
    amount: '',
    reason: ''
  });

  useEffect(() => {
    loadInitialData();
  }, []);

  useEffect(() => {
    if (selectedRepresentative) {
      loadRepresentativeData(selectedRepresentative);
    }
  }, [selectedRepresentative]);

  const loadInitialData = async () => {
    setLoading(true);
    try {
      const [paymentsRes, repsRes] = await Promise.all([
        axios.get('/api/payments'),
        axios.get('/api/representatives')
      ]);

      setPayments(paymentsRes.data.data || []);
      setRepresentatives(repsRes.data.data || []);

    } catch (error) {
      console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡:', error);
    }
    setLoading(false);
  };

  const loadRepresentativeData = async (representativeId: number) => {
    try {
      const [unallocatedRes, invoicesRes] = await Promise.all([
        axios.get(`/api/payments/unallocated/${representativeId}`),
        axios.get(`/api/invoices/representative/${representativeId}`)
      ]);

      setUnallocatedPayments(unallocatedRes.data.data || []);
      setInvoices(invoicesRes.data.invoices || []);

    } catch (error) {
      console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡:', error);
    }
  };

  const handleAutoAllocation = async () => {
    if (!selectedRepresentative) {
      alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
      return;
    }

    setLoading(true);
    try {
      console.log(`ğŸš€ SHERLOCK v34.1: Starting auto-allocation for representative ${selectedRepresentative}`);

      const response = await axios.post(`/api/payments/auto-allocate/${selectedRepresentative}`, {
        rules: {
          method: 'FIFO',
          allowPartialAllocation: true,
          allowOverAllocation: false,
          priorityInvoiceStatuses: ['overdue', 'unpaid', 'partial'],
          strictValidation: true,
          auditMode: true
        }
      });

      if (response.data.success) {
        setAutoAllocationResults(response.data);
        console.log(`âœ… Auto-allocation completed:`, response.data.summary);

        // Reload data
        await loadRepresentativeData(selectedRepresentative);
        await loadInitialData();

      } else {
        console.error('âŒ Auto-allocation failed:', response.data);
        alert('Ø®Ø·Ø§ Ø¯Ø± ØªØ®ØµÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø±: ' + (response.data.error || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'));
      }
    } catch (error) {
      console.error('âŒ Auto-allocation error:', error);
      alert('Ø®Ø·Ø§ Ø¯Ø± ØªØ®ØµÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø±');
    }
    setLoading(false);
  };

  const handleManualAllocation = async () => {
    if (!manualForm.paymentId || !manualForm.invoiceId || !manualForm.amount) {
      alert('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù„Ø§Ø²Ù… Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
      return;
    }

    setLoading(true);
    try {
      console.log(`ğŸ¯ SHERLOCK v34.1: Manual allocation:`, manualForm);

      const response = await axios.post('/api/payments/manual-allocate', {
        paymentId: parseInt(manualForm.paymentId),
        invoiceId: parseInt(manualForm.invoiceId),
        amount: parseFloat(manualForm.amount),
        reason: manualForm.reason || 'ØªØ®ØµÛŒØµ Ø¯Ø³ØªÛŒ'
      });

      if (response.data.success) {
        console.log(`âœ… Manual allocation successful:`, response.data.data);
        alert('ØªØ®ØµÛŒØµ Ø¯Ø³ØªÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');

        // Reset form and close dialog
        setManualForm({ paymentId: '', invoiceId: '', amount: '', reason: '' });
        setManualAllocationDialog(false);
        setSelectedPayment(null);

        // Reload data
        if (selectedRepresentative) {
          await loadRepresentativeData(selectedRepresentative);
        }
        await loadInitialData();

      } else {
        console.error('âŒ Manual allocation failed:', response.data);
        alert('Ø®Ø·Ø§ Ø¯Ø± ØªØ®ØµÛŒØµ Ø¯Ø³ØªÛŒ: ' + (response.data.error || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'));
      }
    } catch (error) {
      console.error('âŒ Manual allocation error:', error);
      alert('Ø®Ø·Ø§ Ø¯Ø± ØªØ®ØµÛŒØµ Ø¯Ø³ØªÛŒ');
    }
    setLoading(false);
  };

  const openManualAllocationDialog = (payment: Payment) => {
    setSelectedPayment(payment);
    setManualForm({
      paymentId: payment.id.toString(),
      invoiceId: '',
      amount: payment.amount,
      reason: ''
    });
    setManualAllocationDialog(true);
  };

  const getStatusBadge = (isAllocated: boolean) => {
    return isAllocated ? (
      <Badge variant="default" className="bg-green-500">
        <CheckCircle className="w-4 h-4 mr-1" />
        ØªØ®ØµÛŒØµ ÛŒØ§ÙØªÙ‡
      </Badge>
    ) : (
      <Badge variant="secondary">
        <Clock className="w-4 h-4 mr-1" />
        ØªØ®ØµÛŒØµ Ù†ÛŒØ§ÙØªÙ‡
      </Badge>
    );
  };

  const formatCurrency = (amount: string | number) => {
    return new Intl.NumberFormat('fa-IR').format(Number(amount)) + ' ØªÙˆÙ…Ø§Ù†';
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('fa-IR');
  };

  if (loading && payments.length === 0) {
    return (
      <div className="flex justify-center items-center h-64">
        <div className="text-lg">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
      </div>
    );
  }

  return (
    <div className="space-y-6" dir="rtl">
      {/* Header */}
      <div className="flex justify-between items-center">
        <h1 className="text-3xl font-bold text-gray-900">
          ğŸ¯ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ®ØµÛŒØµ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§
        </h1>
        <div className="text-sm text-gray-500">
          SHERLOCK v34.1 - ATOMOS Protocol
        </div>
      </div>

      {/* Representative Selection */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center">
            <Target className="w-5 h-5 mr-2" />
            Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡
          </CardTitle>
          <CardDescription>
            Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ ØªØ®ØµÛŒØµØŒ Ø§Ø¨ØªØ¯Ø§ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
            <div>
              <Label htmlFor="representative-select">Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡</Label>
              <Select 
                value={selectedRepresentative?.toString() || ''} 
                onValueChange={(value) => setSelectedRepresentative(parseInt(value))}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯..." />
                </SelectTrigger>
                <SelectContent>
                  {representatives.map(rep => (
                    <SelectItem key={rep.id} value={rep.id.toString()}>
                      {rep.name} ({rep.code}) - Ø¨Ø¯Ù‡ÛŒ: {formatCurrency(rep.totalDebt)}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div>
              <Button 
                onClick={handleAutoAllocation} 
                disabled={!selectedRepresentative || loading}
                className="w-full"
                size="lg"
              >
                <Zap className="w-4 h-4 mr-2" />
                ØªØ®ØµÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø± (FIFO)
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Auto-allocation Results */}
      {autoAllocationResults && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center">
              {autoAllocationResults.success ? (
                <CheckCircle className="w-5 h-5 mr-2 text-green-500" />
              ) : (
                <XCircle className="w-5 h-5 mr-2 text-red-500" />
              )}
              Ù†ØªØ§ÛŒØ¬ ØªØ®ØµÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø±
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
              <div className="text-center">
                <div className="text-2xl font-bold text-blue-600">
                  {autoAllocationResults.summary?.totalProcessed || 0}
                </div>
                <div className="text-sm text-gray-500">Ù¾Ø±Ø¯Ø§Ø®Øª Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù‡</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-green-600">
                  {formatCurrency(autoAllocationResults.summary?.totalAllocated || 0)}
                </div>
                <div className="text-sm text-gray-500">Ù…Ø¨Ù„Øº ØªØ®ØµÛŒØµ ÛŒØ§ÙØªÙ‡</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-red-600">
                  {autoAllocationResults.summary?.totalErrors || 0}
                </div>
                <div className="text-sm text-gray-500">Ø®Ø·Ø§</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-purple-600">
                  {Math.round(autoAllocationResults.summary?.processingTime || 0)}ms
                </div>
                <div className="text-sm text-gray-500">Ø²Ù…Ø§Ù† Ù¾Ø±Ø¯Ø§Ø²Ø´</div>
              </div>
            </div>

            {autoAllocationResults.results && autoAllocationResults.results.length > 0 && (
              <div>
                <h4 className="font-medium mb-2">Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ®ØµÛŒØµ:</h4>
                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {autoAllocationResults.results.map((result: any, index: number) => (
                    <div key={index} className="flex justify-between items-center p-2 bg-gray-50 rounded">
                      <span>Ù¾Ø±Ø¯Ø§Ø®Øª {result.paymentId}</span>
                      {result.success ? (
                        <div className="text-green-600">
                          âœ… {formatCurrency(result.allocatedAmount)} ØªØ®ØµÛŒØµ ÛŒØ§ÙØª
                        </div>
                      ) : (
                        <div className="text-red-600">
                          âŒ {result.errors?.[0] || 'Ø®Ø·Ø§ Ø¯Ø± ØªØ®ØµÛŒØµ'}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}
          </CardContent>
        </Card>
      )}

      <Tabs defaultValue="unallocated" className="w-full">
        <TabsList className="grid w-full grid-cols-3">
          <TabsTrigger value="unallocated">Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ ØªØ®ØµÛŒØµ Ù†ÛŒØ§ÙØªÙ‡</TabsTrigger>
          <TabsTrigger value="allocated">Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ ØªØ®ØµÛŒØµ ÛŒØ§ÙØªÙ‡</TabsTrigger>
          <TabsTrigger value="invoices">ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ ØªØ®ØµÛŒØµ</TabsTrigger>
        </TabsList>

        <TabsContent value="unallocated" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ ØªØ®ØµÛŒØµ Ù†ÛŒØ§ÙØªÙ‡</CardTitle>
              <CardDescription>
                {selectedRepresentative 
                  ? `${unallocatedPayments.length} Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ®ØµÛŒØµ Ù†ÛŒØ§ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡`
                  : 'Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'
                }
              </CardDescription>
            </CardHeader>
            <CardContent>
              {selectedRepresentative ? (
                <div className="space-y-4">
                  {unallocatedPayments.length > 0 ? (
                    unallocatedPayments.map(payment => (
                      <div key={payment.id} className="flex justify-between items-center p-4 border rounded-lg">
                        <div>
                          <div className="font-medium">Ù¾Ø±Ø¯Ø§Ø®Øª #{payment.id}</div>
                          <div className="text-sm text-gray-500">
                            {formatDate(payment.paymentDate)} - {payment.description || 'Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­'}
                          </div>
                        </div>
                        <div className="flex items-center space-x-2 space-x-reverse">
                          <div className="text-lg font-bold text-blue-600">
                            {formatCurrency(payment.amount)}
                          </div>
                          {getStatusBadge(payment.isAllocated)}
                          <Button 
                            onClick={() => openManualAllocationDialog(payment)}
                            variant="outline"
                            size="sm"
                          >
                            ØªØ®ØµÛŒØµ Ø¯Ø³ØªÛŒ
                          </Button>
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="text-center py-8 text-gray-500">
                      Ù‡ÛŒÚ† Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ®ØµÛŒØµ Ù†ÛŒØ§ÙØªÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                    </div>
                  )}
                </div>
              ) : (
                <div className="text-center py-8 text-gray-500">
                  Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="allocated" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ ØªØ®ØµÛŒØµ ÛŒØ§ÙØªÙ‡</CardTitle>
              <CardDescription>
                ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ ØªØ®ØµÛŒØµ ÛŒØ§ÙØªÙ‡â€ŒØ§Ù†Ø¯
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {payments.filter(p => p.isAllocated && (!selectedRepresentative || p.representativeId === selectedRepresentative)).map(payment => (
                  <div key={payment.id} className="flex justify-between items-center p-4 border rounded-lg bg-green-50">
                    <div>
                      <div className="font-medium">Ù¾Ø±Ø¯Ø§Ø®Øª #{payment.id}</div>
                      <div className="text-sm text-gray-500">
                        {formatDate(payment.paymentDate)} - {payment.description || 'Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­'}
                      </div>
                      {payment.invoiceId && (
                        <div className="text-sm text-green-600">
                          ØªØ®ØµÛŒØµ ÛŒØ§ÙØªÙ‡ Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ± #{payment.invoiceId}
                        </div>
                      )}
                    </div>
                    <div className="flex items-center space-x-2 space-x-reverse">
                      <div className="text-lg font-bold text-green-600">
                        {formatCurrency(payment.amount)}
                      </div>
                      {getStatusBadge(payment.isAllocated)}
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="invoices" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ ØªØ®ØµÛŒØµ</CardTitle>
              <CardDescription>
                ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯
              </CardDescription>
            </CardHeader>
            <CardContent>
              {selectedRepresentative ? (
                <div className="space-y-4">
                  {invoices.filter(inv => ['unpaid', 'partial', 'overdue'].includes(inv.status)).map(invoice => (
                    <div key={invoice.id} className="flex justify-between items-center p-4 border rounded-lg">
                      <div>
                        <div className="font-medium">ÙØ§Ú©ØªÙˆØ± {invoice.invoiceNumber}</div>
                        <div className="text-sm text-gray-500">
                          ØµØ§Ø¯Ø±Ù‡: {formatDate(invoice.issueDate)}
                          {invoice.dueDate && ` - Ø³Ø±Ø±Ø³ÛŒØ¯: ${formatDate(invoice.dueDate)}`}
                        </div>
                      </div>
                      <div className="flex items-center space-x-2 space-x-reverse">
                        <div className="text-lg font-bold">
                          {formatCurrency(invoice.amount)}
                        </div>
                        <Badge 
                          variant={
                            invoice.status === 'overdue' ? 'destructive' : 
                            invoice.status === 'partial' ? 'secondary' : 'default'
                          }
                        >
                          {invoice.status === 'unpaid' && 'Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø´Ø¯Ù‡'}
                          {invoice.status === 'partial' && 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø¬Ø²Ø¦ÛŒ'}
                          {invoice.status === 'overdue' && 'Ù…Ø¹ÙˆÙ‚'}
                        </Badge>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8 text-gray-500">
                  Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>

      {/* Manual Allocation Dialog */}
      <Dialog open={manualAllocationDialog} onOpenChange={setManualAllocationDialog}>
        <DialogContent className="max-w-md" dir="rtl">
          <DialogHeader>
            <DialogTitle>ØªØ®ØµÛŒØµ Ø¯Ø³ØªÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª</DialogTitle>
            <DialogDescription>
              Ù¾Ø±Ø¯Ø§Ø®Øª #{selectedPayment?.id} - Ù…Ø¨Ù„Øº: {selectedPayment && formatCurrency(selectedPayment.amount)}
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4">
            <div>
              <Label htmlFor="invoice-select">ÙØ§Ú©ØªÙˆØ± Ù…Ù‚ØµØ¯</Label>
              <Select 
                value={manualForm.invoiceId} 
                onValueChange={(value) => setManualForm(prev => ({...prev, invoiceId: value}))}
              >
                <SelectTrigger>
                  <SelectValue placeholder="ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯..." />
                </SelectTrigger>
                <SelectContent>
                  {invoices.filter(inv => ['unpaid', 'partial', 'overdue'].includes(inv.status)).map(invoice => (
                    <SelectItem key={invoice.id} value={invoice.id.toString()}>
                      {invoice.invoiceNumber} - {formatCurrency(invoice.amount)} ({invoice.status})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div>
              <Label htmlFor="amount-input">Ù…Ø¨Ù„Øº ØªØ®ØµÛŒØµ</Label>
              <Input
                id="amount-input"
                type="number"
                value={manualForm.amount}
                onChange={(e) => setManualForm(prev => ({...prev, amount: e.target.value}))}
                placeholder="Ù…Ø¨Ù„Øº ØªØ®ØµÛŒØµ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"
              />
            </div>

            <div>
              <Label htmlFor="reason-input">Ø¯Ù„ÛŒÙ„ ØªØ®ØµÛŒØµ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</Label>
              <Textarea
                id="reason-input"
                value={manualForm.reason}
                onChange={(e) => setManualForm(prev => ({...prev, reason: e.target.value}))}
                placeholder="Ø¯Ù„ÛŒÙ„ Ø§ÛŒÙ† ØªØ®ØµÛŒØµ Ø¯Ø³ØªÛŒ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."
                rows={3}
              />
            </div>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setManualAllocationDialog(false)}>
              Ø§Ù†ØµØ±Ø§Ù
            </Button>
            <Button onClick={handleManualAllocation} disabled={loading}>
              {loading ? 'Ø¯Ø± Ø­Ø§Ù„ ØªØ®ØµÛŒØµ...' : 'ØªØ®ØµÛŒØµ Ø¯Ø³ØªÛŒ'}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
};

export default PaymentManagement;